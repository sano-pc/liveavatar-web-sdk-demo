# LiveAvatar Demo 使用ガイド

このドキュメントでは、LiveAvatar Demoアプリケーションの各ボタン、ラベル、機能について説明します。

## 開発環境と本番環境の違い

このアプリケーションは、実行環境によって表示されるUIが自動的に切り替わります。

| 環境         | 起動コマンド                        | 表示されるUI                                                                                                                                | 自動クリーンアップ        |
| ------------ | ----------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------- |
| **開発環境** | `pnpm demo`<br>または<br>`pnpm dev` | • アバタービデオ<br>• **Stopボタン**<br>• **デバッグUI**（ステータス表示、コントロールボタン）<br>• チャット入力（input、Send、**Repeat**） | ✅ ページ離脱時に自動停止 |
| **本番環境** | `pnpm build`<br>`pnpm start`        | • アバタービデオ<br>• チャット入力（input、**Sendのみ**）                                                                                   | ✅ ページ離脱時に自動停止 |

### 自動クリーンアップ機能

セッションは以下のタイミングで自動的に停止されます：

- ブラウザのタブを閉じる
- ページをリロード
- 別のページに遷移
- コンポーネントがアンマウント（画面を切り替える）

本番環境ではStopボタンが表示されませんが、ページを離れると自動的にセッションがクリーンアップされるため、手動で停止する必要はありません。

---

## 初期画面

### セッション開始ボタン

| ボタン名                        | モード | 機能説明                                                                 | 特徴                                                                               | 必要な環境変数                                                                                    |
| ------------------------------- | ------ | ------------------------------------------------------------------------ | ---------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------- |
| **Start Full Avatar Session**   | FULL   | HeyGenが提供する音声とコンテキストを使用したフル機能のアバターセッション | • 音声会話機能が利用可能<br>• ユーザー発話の自動認識<br>• コンテキストに基づく応答 | `LIVEAVATAR_API_KEY`<br>`LIVEAVATAR_VOICE_ID`<br>`LIVEAVATAR_CONTEXT_ID`<br>`LIVEAVATAR_LANGUAGE` |
| **Start Custom Avatar Session** | CUSTOM | カスタムAI・音声合成を使用したアバターセッション                         | • OpenAI統合<br>• ElevenLabs音声合成<br>• 柔軟なカスタマイズ                       | `LIVEAVATAR_API_KEY`<br>`OPENAI_API_KEY`<br>`ELEVENLABS_API_KEY`                                  |

---

## セッション画面

### UI構成

| エリア                 | 要素                   | 説明                                                       | 表示環境         |
| ---------------------- | ---------------------- | ---------------------------------------------------------- | ---------------- |
| **ビデオ表示エリア**   | 動画プレイヤー         | アバターの映像を表示。会話中の動きや表情が反映される       | 全環境           |
|                        | **Stopボタン**（右下） | セッションを停止し、初期画面に戻る。全リソースが解放される | **開発環境のみ** |
| **チャット入力エリア** | テキスト入力欄         | アバターに送信するメッセージを入力                         | 全環境           |
|                        | **Sendボタン**         | 入力したテキストをアバターに送信（LLMで処理）              | 全環境           |
|                        | **Repeatボタン**       | 入力したテキストをそのまま読み上げ                         | **開発環境のみ** |

### ステータス表示ラベル（開発環境のみ）

| ラベル名               | 表示される値                                       | 説明                                                                   | 表示モード                              |
| ---------------------- | -------------------------------------------------- | ---------------------------------------------------------------------- | --------------------------------------- |
| **Session state**      | `INACTIVE` `CONNECTING` `CONNECTED` `DISCONNECTED` | セッションの現在の状態                                                 | 全モード                                |
| **Connection quality** | `good` `poor` `disconnected` など                  | ネットワーク接続の品質をリアルタイムで監視                             | 全モード                                |
| **User talking**       | `true` / `false`                                   | ユーザーが話しているかどうか（マイク入力検出）                         | **FULLのみ**                            |
| **Avatar talking**     | `true` / `false`                                   | アバターが音声を出力中かどうか                                         | 全モード                                |
| **Voice Chat Active**  | `true` / `false`                                   | 音声チャット機能が有効かどうか                                         | **FULLのみ**                            |
| **Voice Chat Loading** | `true` / `false`                                   | 音声チャット機能の初期化中かどうか                                     | **FULLのみ**                            |
| **Muted**              | `true` / `false`                                   | マイクがミュート状態かどうか（ミュート中でもアバターの音声は聞こえる） | **FULLのみ**<br>（Voice Chat Active時） |

---

### コントロールボタン（開発環境のみ）

| ボタン名                                    | 機能                         | 動作説明                                                                                                                                      | 利用可能モード                          | 備考                                      |
| ------------------------------------------- | ---------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------- | ----------------------------------------- |
| **Start Voice Chat**<br>**Stop Voice Chat** | 音声会話の開始/停止          | • **Start**: マイクを使った音声会話を開始<br>• **Stop**: 音声会話を停止<br>音声会話を開始すると、ユーザーの発話をアバターが聞き取り、応答する | **FULLのみ**                            | Voice Chat Loadingが`false`の時に操作可能 |
| **Mute**<br>**Unmute**                      | マイクのミュート切替         | • **Mute**: マイクをミュートし、音声をアバターに送らない<br>• **Unmute**: マイクのミュートを解除<br>一時的に話したくない時に使用              | **FULLのみ**<br>（Voice Chat Active時） | ミュート中もアバターの音声は聞こえる      |
| **Keep Alive**                              | セッションのタイムアウト防止 | セッションの有効期限を延長する<br>長時間操作がない場合、セッションは自動的に終了する可能性がある                                              | 全モード                                | セッション継続時に定期的に押す            |
| **Start Listening**                         | 発話の聞き取り開始           | アバターがユーザーの発話を待機する状態にする<br>• **FULLモード**: 音声会話で使用<br>• **CUSTOMモード**: カスタム実装で使用                    | 全モード                                | -                                         |
| **Stop Listening**                          | 発話の聞き取り停止           | アバターがユーザーの発話を聞き取るのを停止                                                                                                    | 全モード                                | -                                         |
| **Interrupt**                               | アバター発話の中断           | アバターが話している最中に、発話を強制的に停止<br>長い応答を中断したい時に便利                                                                | 全モード                                | Avatar talkingが`true`の時に有効          |

### テキスト入力エリア

| 要素               | 機能             | 動作説明                                                                                                                               | 使用例                               | 表示環境         |
| ------------------ | ---------------- | -------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------ | ---------------- |
| **テキスト入力欄** | メッセージ入力   | アバターに送信するテキストメッセージをキーボードで入力                                                                                 | 「こんにちは」と入力                 | 全環境           |
| **Send ボタン**    | テキスト送信     | 入力したテキストメッセージをアバターに送信<br>• **FULLモード**: コンテキストに基づいて応答<br>• **CUSTOMモード**: OpenAIが処理して応答 | 「こんにちは」→ Sendで挨拶を返す     | 全環境           |
| **Repeat ボタン**  | テキスト読み上げ | 入力されたテキストをそのまま音声で読み上げ<br>LLMによる処理は行われない                                                                | 「テスト」→ Repeatで「テスト」と発話 | **開発環境のみ** |

---

## モード別の機能比較

| 機能             | FULLモード        | CUSTOMモード                      |
| ---------------- | ----------------- | --------------------------------- |
| 音声会話         | ✅ 利用可能       | ❌ 利用不可（カスタム実装が必要） |
| テキストチャット | ✅ HeyGenのAI使用 | ✅ OpenAI使用                     |
| テキスト読み上げ | ✅ HeyGenの音声   | ✅ ElevenLabs使用                 |
| ユーザー発話検出 | ✅ 自動検出       | ❌ カスタム実装が必要             |
| コンテキスト設定 | ✅ 事前設定可能   | ✅ カスタム実装                   |

---

## トラブルシューティング

| 問題                                                  | 原因                   | 解決方法                                                                                                        |
| ----------------------------------------------------- | ---------------------- | --------------------------------------------------------------------------------------------------------------- |
| **エラー:**<br>`LIVEAVATAR_API_KEY is not configured` | APIキーが未設定        | 1. `apps/demo/.env.local`ファイルを作成<br>2. `LIVEAVATAR_API_KEY=あなたのAPIキー`を設定<br>3. サーバーを再起動 |
| **セッションが自動的に切断される**                    | セッションタイムアウト | 定期的に「Keep Alive」ボタンを押す                                                                              |
| **アバターの音声が聞こえない**                        | 音量・接続の問題       | • ブラウザの音量設定を確認<br>• ビデオ要素がミュートされていないか確認<br>• スピーカー/ヘッドフォンの接続を確認 |
| **マイクが動作しない**<br>（FULLモード）              | マイク許可・設定の問題 | • ブラウザのマイクアクセス許可を確認<br>• システムのマイク設定を確認<br>• 「Muted」が`false`であることを確認    |

---

## 使用例

### 基本的な会話の流れ（FULLモード）

| ステップ | 操作                                          | 確認事項                          |
| -------- | --------------------------------------------- | --------------------------------- |
| 1        | 「Start Full Avatar Session」ボタンをクリック | -                                 |
| 2        | セッション接続を待つ                          | Session state: `CONNECTED` を確認 |
| 3        | 「Start Voice Chat」ボタンをクリック          | Voice Chat Active: `true` を確認  |
| 4        | アバターに話しかける                          | User talking: `true` になる       |
| 5        | アバターが応答する                            | Avatar talking: `true` になる     |
| 6        | 会話を終了                                    | 「Stop Voice Chat」をクリック     |
| 7        | セッションを終了                              | 「Stop」ボタンをクリック          |

### 操作パターン別ガイド

| 操作パターン                 | 手順                                                                                              | 結果                                     |
| ---------------------------- | ------------------------------------------------------------------------------------------------- | ---------------------------------------- |
| **テキストで会話**           | 1. セッションを開始<br>2. テキスト入力欄に質問を入力<br>3. 「Send」ボタンをクリック               | アバターが応答を生成して発話             |
| **テキストを読み上げさせる** | 1. セッションを開始<br>2. テキスト入力欄に読み上げたい文章を入力<br>3. 「Repeat」ボタンをクリック | アバターが入力テキストをそのまま読み上げ |
| **アバターの長い話を中断**   | アバター発話中に「Interrupt」ボタンをクリック                                                     | アバターの発話が即座に停止               |
